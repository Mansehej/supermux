#!/usr/bin/env bash
set -euo pipefail

TMUX_BIN="${TMX_TMUX_BIN:-tmux}"
TMUX_SOCKET_NAME="${TMX_TMUX_SOCKET-supermux}"
TMUX_SOCKET_PATH="${TMX_TMUX_SOCKET_PATH:-}"

PICKER_QUERY="${TMX_QUERY:-${TMX_PROCESS_QUERY:-}}"
SCOPE_DIR="${TMX_SCOPE_DIR:-${PWD:-.}}"
SCOPE_MODE="${TMX_SCOPE_MODE:-pwd}" # pwd | git
ALL="${TMX_ALL:-0}"
TSV=0
PICKER_RESULT=""

have() { command -v "$1" >/dev/null 2>&1; }
die() { printf 'supermux: %s\n' "$*" >&2; exit 1; }

require_tmux() { have "$TMUX_BIN" || die "tmux not found"; }
require_bun() { have bun || die "bun not found (macOS: brew install bun)"; }

resolve_opentui_picker_script() {
  local override="${TMX_OPENTUI_PICKER_SCRIPT:-}"
  if [[ -n "$override" ]]; then
    [[ -f "$override" ]] || die "opentui picker script not found: $override"
    printf '%s' "$override"
    return 0
  fi

  local self_dir
  self_dir="$(dirname "$TMX_SELF")"

  local script
  script="${self_dir}/../scripts/opentui-picker.ts"
  if [[ -f "$script" ]]; then
    printf '%s' "$script"
    return 0
  fi

  script="${self_dir}/../share/supermux/opentui-picker.ts"
  if [[ -f "$script" ]]; then
    printf '%s' "$script"
    return 0
  fi

  if [[ -n "${HOME:-}" ]]; then
    script="${HOME}/.local/share/supermux/opentui-picker.ts"
    if [[ -f "$script" ]]; then
      printf '%s' "$script"
      return 0
    fi
  fi

  script="/usr/local/share/supermux/opentui-picker.ts"
  if [[ -f "$script" ]]; then
    printf '%s' "$script"
    return 0
  fi

  script="/usr/share/supermux/opentui-picker.ts"
  if [[ -f "$script" ]]; then
    printf '%s' "$script"
    return 0
  fi

  die "opentui picker script not found; reinstall with ./scripts/install.sh"
}

run_opentui_picker_once() {
  local mode="${1:-pick}"
  local picker_script
  picker_script="$(resolve_opentui_picker_script)"

  local data_file result_file
  data_file="$(mktemp "${TMPDIR:-/tmp}/supermux-picker-data.XXXXXX")"
  result_file="$(mktemp "${TMPDIR:-/tmp}/supermux-picker-result.XXXXXX")"

  if [[ "$mode" == "pick" ]]; then
    list_picker_lines >"$data_file"
  elif [[ "$mode" == "kill" ]]; then
    list_picker_lines | awk -F$'\t' '$4 == "S" {print}' >"$data_file"
  else
    list_picker_lines | awk -F$'\t' '$4 == "S" && $8 != "0" {print}' >"$data_file"
  fi

  local -a picker_cmd
  picker_cmd=(bun "$picker_script" --mode "$mode" --data-file "$data_file" --result-file "$result_file" --query "${PICKER_QUERY:-}")

  local picker_ok=0
  if [[ -t 0 && -t 1 ]]; then
    if "${picker_cmd[@]}"; then
      picker_ok=1
    fi
  elif [[ -r /dev/tty && -w /dev/tty ]]; then
    if : </dev/tty >/dev/tty 2>/dev/tty; then
      if "${picker_cmd[@]}" </dev/tty >/dev/tty 2>/dev/tty; then
        picker_ok=1
      fi
    else
      rm -f "$data_file" "$result_file"
      die "interactive mode requires a terminal"
    fi
  else
    rm -f "$data_file" "$result_file"
    die "interactive mode requires a terminal"
  fi

  if [[ "$picker_ok" != "1" ]]; then
    rm -f "$data_file" "$result_file"
    die "opentui picker failed"
  fi

  local result=""
  if [[ -s "$result_file" ]]; then
    IFS= read -r result <"$result_file" || true
  fi

  rm -f "$data_file" "$result_file"
  PICKER_RESULT="$result"
}

run_opentui_picker_loop() {
  local mode="${1:-pick}"

  while :; do
    run_opentui_picker_once "$mode"
    local result="$PICKER_RESULT"
    [[ -n "$result" ]] || return 0

    local action session win
    IFS=$'\t' read -r action session win <<<"$result"

    case "$action" in
      attach)
        [[ -n "$session" ]] || return 0
        if [[ -n "$win" && "$win" != "-" ]]; then
          tmux_cmd select-window -t "${session}:${win}" 2>/dev/null || true
        fi
        attach_or_switch "$session"
        return 0
        ;;
      new)
        [[ -n "$session" ]] || continue
        new_session "$session"
        return 0
        ;;
      detach)
        [[ -n "$session" ]] && detach_sessions "$session"
        ;;
      kill)
        [[ -n "$session" ]] || continue
        if [[ "$mode" == "kill" ]]; then
          printf 'Kill %s? [y/N] ' "$session" > /dev/tty
          local ans
          read -r ans < /dev/tty || return 0
          case "$ans" in
            y|Y|yes|YES) kill_sessions "$session" ;;
          esac
        else
          kill_sessions "$session"
        fi
        ;;
      refresh)
        ;;
      cancel|"")
        return 0
        ;;
      *)
        return 0
        ;;
    esac

    if [[ "$mode" == "detach" ]]; then
      return 0
    fi
  done
}

canonical_path() {
  local dir="$1"
  if [[ -d "$dir" ]]; then
    (cd "$dir" 2>/dev/null && pwd -P) || printf '%s' "$dir"
  else
    printf '%s' "$dir"
  fi
}

short_path() {
  local p="${1:-}"
  [[ -n "$p" && "$p" != "-" ]] || {
    printf '%s' "${p:-}"
    return 0
  }

  local home="${HOME:-}"
  if [[ -n "$home" ]]; then
    if [[ "$p" == "$home" ]]; then
      p="~"
    elif [[ "$p" == "$home/"* ]]; then
      p="~/${p#$home/}"
    fi
  fi

  local max=56
  if [[ ${#p} -le $max ]]; then
    printf '%s' "$p"
    return 0
  fi

  local base parent
  base="$(basename "$p")"
  parent="$(basename "$(dirname "$p")")"
  printf '.../%s/%s' "$parent" "$base"
}

scope_root() {
  local dir
  dir="$(canonical_path "$SCOPE_DIR")"

  if [[ "$SCOPE_MODE" == "git" ]] && have git; then
    local git_root
    git_root="$(git -C "$dir" rev-parse --show-toplevel 2>/dev/null || true)"
    if [[ -n "$git_root" ]]; then
      canonical_path "$git_root"
      return 0
    fi
  fi

  printf '%s' "$dir"
}

sanitize_session_name() {
  local s="$1"
  s="$(printf '%s' "$s" | tr ' ' '-' | tr -cd '[:alnum:]_-')"
  s="$(printf '%s' "$s" | sed 's/--*/-/g; s/^-//; s/-$//')"
  [[ -n "$s" ]] || s="session"
  case "$s" in
    -*) s="s${s}" ;;
  esac
  printf '%s' "$s"
}

short_hash() {
  local input="$1"
  if have shasum; then
    printf '%s' "$input" | shasum -a 256 | awk '{print substr($1,1,8)}'
    return 0
  fi
  if have python3; then
    python3 -c 'import hashlib,sys; print(hashlib.sha256(sys.argv[1].encode()).hexdigest()[:8])' "$input"
    return 0
  fi
  printf '%s' "$input" | cksum | awk '{print $1}'
}

tmux_cmd() {
  if [[ -n "$TMUX_SOCKET_PATH" ]]; then
    "$TMUX_BIN" -S "$TMUX_SOCKET_PATH" "$@"
    return
  fi

  if [[ -n "$TMUX_SOCKET_NAME" ]]; then
    "$TMUX_BIN" -L "$TMUX_SOCKET_NAME" "$@"
    return
  fi

  "$TMUX_BIN" "$@"
}

set_session_meta() {
  local session="$1"
  local root="$2"
  local logical="$3"

  tmux_cmd set-option -t "$session" -q @tmx_root "$root"
  tmux_cmd set-option -t "$session" -q @tmx_name "$logical"
}

find_session_by_meta() {
  local root="$1"
  local logical="$2"

  local session r n
  while IFS=$'\t' read -r session r n; do
    [[ -n "${session:-}" ]] || continue
    [[ "${r:-}" == "$root" ]] || continue

    if [[ -n "${n:-}" ]]; then
      [[ "$n" == "$logical" ]] || continue
      printf '%s' "$session"
      return 0
    fi

    [[ "$session" == "$logical" ]] || continue
    printf '%s' "$session"
    return 0
  done < <(
    tmux_cmd list-sessions -F $'#{session_name}\t#{?@tmx_root,#{@tmx_root},-}\t#{?@tmx_name,#{@tmx_name},#{session_name}}' 2>/dev/null || true
  )

  return 1
}

choose_actual_session_name() {
  local root="$1"
  local logical="$2"

  local slug base h cand
  slug="$(sanitize_session_name "$logical")"
  base="$(sanitize_session_name "$(basename "$root")")"
  h="$(short_hash "$root")"

  for cand in "$slug" "${base}--${slug}" "${slug}--${h}" "${base}--${slug}--${h}"; do
    if ! tmux_cmd has-session -t "$cand" 2>/dev/null; then
      printf '%s' "$cand"
      return 0
    fi
  done

  local i=2
  while :; do
    cand="${slug}--${h}--${i}"
    if ! tmux_cmd has-session -t "$cand" 2>/dev/null; then
      printf '%s' "$cand"
      return 0
    fi
    i=$((i + 1))
  done
}

attach_or_switch() {
  local session="$1"
  [[ -n "$session" ]] || return 0

  if [[ -n "${TMUX:-}" ]] && tmux_cmd display-message -p '#{client_pid}' >/dev/null 2>&1; then
    tmux_cmd switch-client -t "$session"
  else
    tmux_cmd attach-session -t "$session"
  fi
}

default_logical_name() {
  local root="$1"
  local n
  n="$(basename "$root")"
  [[ -n "$n" && "$n" != "/" && "$n" != "." ]] || n="main"
  printf '%s' "$n"
}

new_session() {
  local logical="${1:-}"
  local root="$SCOPE_ROOT"

  [[ -n "$logical" ]] || logical="$(default_logical_name "$root")"

  local existing
  existing="$(find_session_by_meta "$root" "$logical" || true)"
  if [[ -n "$existing" ]]; then
    attach_or_switch "$existing"
    return 0
  fi

  local actual
  actual="$(choose_actual_session_name "$root" "$logical")"

  tmux_cmd new-session -d -s "$actual" -c "$root"
  set_session_meta "$actual" "$root" "$logical"
  attach_or_switch "$actual"
}

list_lines() {
  local filter_root="$SCOPE_ROOT"

  (tmux_cmd list-sessions -F $'#{session_name}\t#{session_windows}\t#{session_attached}\t#{?session_activity_string,#{session_activity_string},-}\t#{?@tmx_root,#{@tmx_root},-}\t#{?@tmx_name,#{@tmx_name},#{session_name}}' 2>/dev/null || true) \
  | while IFS=$'\t' read -r session wins attached activity root logical; do
      [[ -n "${session:-}" ]] || continue

      if [[ "$ALL" != "1" ]]; then
        [[ -n "${root:-}" && "$root" == "$filter_root" ]] || continue
      fi

      local display="$logical"
      [[ -n "${display:-}" ]] || display="$session"

      local att="-"
      [[ "${attached:-0}" != "0" ]] && att="att"

      local procs
      procs="$(
        (tmux_cmd list-panes -t "$session" -s -F '#{pane_current_command}' 2>/dev/null || true) \
          | sort \
          | uniq -c \
          | awk '{printf "%s%s(%s)", (NR>1?",":""), $2, $1} END{if(NR==0) printf "-"}'
      )"

      local root_out="${root:-}"
      [[ -n "$root_out" ]] || root_out="-"

      printf '%s\t%s\t%s\t%s\t%s\t%s\t%s\n' "$display" "$session" "$root_out" "${wins:-}" "$att" "${activity:-}" "${procs:-}"
    done
}

list_picker_lines() {
  local filter_root="$SCOPE_ROOT"

  (tmux_cmd list-sessions -F $'#{session_name}\t#{session_windows}\t#{session_attached}\t#{?session_activity_string,#{session_activity_string},-}\t#{?@tmx_root,#{@tmx_root},-}\t#{?@tmx_name,#{@tmx_name},#{session_name}}' 2>/dev/null || true) \
  | while IFS=$'\t' read -r session wins attached activity root logical; do
      [[ -n "${session:-}" ]] || continue

      if [[ "$ALL" != "1" ]]; then
        [[ -n "${root:-}" && "$root" == "$filter_root" ]] || continue
      fi

      local root_out="${root:-}"
      [[ -n "$root_out" ]] || root_out="-"

      local procs
      procs="$(
        (tmux_cmd list-panes -t "$session" -s -F '#{pane_current_command}' 2>/dev/null || true) \
          | sort \
          | uniq -c \
          | awk '{printf "%s%s(%s)", (NR>1?",":""), $2, $1} END{if(NR==0) printf "-"}'
      )"

      local label
      label="${logical}  (${wins}w)"
      if [[ "${attached:-0}" != "0" ]]; then
        label+=" [att]"
      fi
      if [[ "$ALL" == "1" ]]; then
        label+="  $(short_path "$root_out")"
      fi
      printf '%s\t%s\t%s\tS\t-\t%s\t%s\t%s\t%s\t%s\n' \
        "$label" "$session" "$root_out" "$logical" "${wins:-}" "${attached:-0}" "${activity:-}" "$procs"

      (tmux_cmd list-windows -t "$session" -F $'#{window_index}\t#{window_name}\t#{window_panes}\t#{?window_active,1,0}' 2>/dev/null || true) \
      | while IFS=$'\t' read -r w_idx w_name w_panes w_active; do
          [[ -n "${w_idx:-}" ]] || continue

          local star=""
          if [[ "${w_active:-0}" == "1" ]]; then
            star=" *"
          fi

          local w_label
          w_label="  - ${w_idx}: ${w_name}  (${w_panes}p)${star}"
          printf '%s\t%s\t%s\tW\t%s\t%s\t%s\t%s\t%s\t%s\n' \
            "$w_label" "$session" "$root_out" "$w_idx" "$logical" "${w_panes:-}" "${attached:-0}" "${activity:-}" "-"
        done
    done
}

preview_one() {
  local session="${1:-}"
  local win_idx="${2:-}"
  [[ -n "$session" ]] || exit 0

  tmux_cmd display-message -p -t "$session" \
    'session=#{session_name}  name=#{@tmx_name}  dir=#{@tmx_root}  windows=#{session_windows}  attached=#{?session_attached,yes,no}  created=#{session_created_string}  activity=#{session_activity_string}' \
    2>/dev/null || true

  printf '\n'
  tmux_cmd list-windows -t "$session" -F '#{window_index}: #{window_name} (#{window_panes} panes)#{?window_active, [active],}' 2>/dev/null || true

  printf '\n'
  if [[ -n "$win_idx" && "$win_idx" != "-" ]]; then
    tmux_cmd list-panes -t "${session}:${win_idx}" -F '#{window_index}.#{pane_index}  #{pane_current_command}  pid=#{pane_pid}  #{pane_current_path}' 2>/dev/null || true
  else
    tmux_cmd list-panes -t "$session" -s -F '#{window_index}.#{pane_index}  #{pane_current_command}  pid=#{pane_pid}  #{pane_current_path}' 2>/dev/null || true
  fi
}

kill_sessions() {
  local session
  for session in "$@"; do
    [[ -n "$session" ]] || continue
    tmux_cmd kill-session -t "$session" 2>/dev/null || true
  done
}

detach_sessions() {
  local session
  for session in "$@"; do
    [[ -n "$session" ]] || continue
    tmux_cmd detach-client -s "$session" 2>/dev/null || true
  done
}

pick_interactive() {
  require_bun
  run_opentui_picker_loop pick
}

kill_interactive() {
  require_bun
  run_opentui_picker_loop kill
}

usage() {
  cat <<'TMX_USAGE'
Usage:
  supermux new NAME            Create/switch to NAME scoped to current dir
  supermux list                List sessions scoped to current dir
  supermux detach [NAME]       Detach current client or detach NAME's clients
  supermux                     Interactive picker (OpenTUI; requires bun)
  supermux kill                Interactive kill (OpenTUI; requires bun)

Options:
  -a, --all               Use all sessions (list/picker/kill)
  -p, --process STR       Prefilter picker entries (alias: --query)
  -q, --query STR         Prefilter picker entries
  --socket NAME           tmux socket name (default: supermux)
  --socket-path PATH      tmux socket path (overrides --socket)
  --tsv                   list: output raw TSV
  --scope DIR             Scope to this directory (default: $PWD)
  --scope-mode pwd|git    Scope root mode (default: pwd)
TMX_USAGE
}

main() {
  local cmd=""
  local cmd_args=()
  local end_opts=0

  while [[ $# -gt 0 ]]; do
    if [[ "$end_opts" == "1" ]]; then
      if [[ -z "$cmd" ]]; then
        cmd="$1"
      else
        cmd_args+=("$1")
      fi
      shift
      continue
    fi

    case "$1" in
      --)
        end_opts=1
        shift
        ;;
      -a|--all)
        ALL=1
        shift
        ;;
      -p|--process|-q|--query)
        [[ $# -ge 2 ]] || die "missing value for $1"
        PICKER_QUERY="$2"
        shift 2
        ;;
      --tsv)
        TSV=1
        shift
        ;;
      --scope)
        [[ $# -ge 2 ]] || die "missing value for $1"
        SCOPE_DIR="$2"
        shift 2
        ;;
      --socket)
        [[ $# -ge 2 ]] || die "missing value for $1"
        TMUX_SOCKET_NAME="$2"
        TMUX_SOCKET_PATH=""
        shift 2
        ;;
      --socket-path)
        [[ $# -ge 2 ]] || die "missing value for $1"
        TMUX_SOCKET_PATH="$2"
        TMUX_SOCKET_NAME=""
        shift 2
        ;;
      --scope-mode)
        [[ $# -ge 2 ]] || die "missing value for $1"
        SCOPE_MODE="$2"
        shift 2
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      -* )
        die "unknown option: $1"
        ;;
      *)
        if [[ -z "$cmd" ]]; then
          cmd="$1"
        else
          cmd_args+=("$1")
        fi
        shift
        ;;
    esac
  done

  [[ -n "$cmd" ]] || cmd="pick"
  if [[ ${#cmd_args[@]} -gt 0 ]]; then
    set -- "${cmd_args[@]}"
  else
    set --
  fi

  require_tmux
  SCOPE_ROOT="$(scope_root)"

  export TMX_SCOPE_DIR="$SCOPE_DIR"
  export TMX_SCOPE_MODE="$SCOPE_MODE"
  export TMX_QUERY="$PICKER_QUERY"
  export TMX_ALL="$ALL"
  export TMX_TMUX_SOCKET="$TMUX_SOCKET_NAME"
  export TMX_TMUX_SOCKET_PATH="$TMUX_SOCKET_PATH"

  TMX_SELF="${BASH_SOURCE[0]}"
  if [[ "$TMX_SELF" != /* ]]; then
    p="$(command -v "$TMX_SELF" 2>/dev/null || true)"
    [[ -n "$p" ]] && TMX_SELF="$p"
  fi
  export TMX_SELF

  case "$cmd" in
    __list)
      list_lines
      ;;
    __pick_list)
      list_picker_lines
      ;;
    __preview)
      preview_one "${1:-}" "${2:-}"
      ;;
    __detach)
      detach_sessions "$@"
      ;;
    __kill)
      kill_sessions "$@"
      ;;

    new)
      new_session "${1:-}"
      ;;

    detach)
      if [[ $# -eq 0 ]]; then
        if [[ -n "${TMUX:-}" ]]; then
          "$TMUX_BIN" detach-client
          exit 0
        fi

        require_bun
        run_opentui_picker_loop detach
        exit 0
      fi

      logical="$1"
      session="$(find_session_by_meta "$SCOPE_ROOT" "$logical" || true)"
      [[ -n "$session" ]] || die "no session '$logical' in scope ($SCOPE_ROOT)"

      tmux_cmd detach-client -s "$session" 2>/dev/null || true
      ;;

    list|ls)
      if [[ "$TSV" == "1" ]]; then
        list_lines
        exit 0
      fi

      if have column; then
        if [[ "$ALL" == "1" ]]; then
          { printf 'NAME\tSESSION\tDIR\tW\tATT\tACTIVITY\tPROCS\n'; list_lines; } | column -t -s $'\t'
        else
          { printf 'NAME\tSESSION\tW\tATT\tACTIVITY\tPROCS\n'; list_lines | awk -F$'\t' 'BEGIN{OFS="\t"} {print $1,$2,$4,$5,$6,$7}'; } | column -t -s $'\t'
        fi
      else
        if [[ "$ALL" == "1" ]]; then
          printf 'NAME\tSESSION\tDIR\tW\tATT\tACTIVITY\tPROCS\n'
          list_lines
        else
          printf 'NAME\tSESSION\tW\tATT\tACTIVITY\tPROCS\n'
          list_lines | awk -F$'\t' 'BEGIN{OFS="\t"} {print $1,$2,$4,$5,$6,$7}'
        fi
      fi
      ;;

    pick)
      pick_interactive
      ;;

    all)
      ALL=1
      export TMX_ALL=1
      pick_interactive
      ;;

    kill)
      kill_interactive
      ;;

    *)
      die "unknown command: $cmd"
      ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  main "$@"
fi
